@page "/JobApply/{JobId:guid}"
@inject HttpClient Http
@using Shared.DTOs
@rendermode InteractiveServer
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage


<h3>Apply for Job</h3>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert alert-info">@statusMessage</div>
}

@if (job == null)
{
    <p>Loading job details...</p>
}
else
{
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">@job.Title</h5>
            <p>@job.Category | @job.WorkTime | @job.Experience</p>
            @if (job.IsSalaryMentionated)
            {
                <p><strong>Salary:</strong> @job.Salary</p>
            }
            <p><strong>Location:</strong> @job.Location</p>
            <p><strong>Skills:</strong> @job.Skills</p>
            <p><strong>Description:</strong> @job.Description</p>
        </div>
    </div>

    <EditForm Model="applicationModel" OnValidSubmit="HandleValidSubmit" FormName="JobApplyForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Full Name</label>
            <InputText class="form-control border-dark" @bind-Value="applicationModel.FullName" />
        </div>

        <div class="mb-3">
            <label class="form-label">Email</label>
            <InputText class="form-control border-dark" type="email" @bind-Value="applicationModel.Email" />
        </div>

        <div class="mb-3">
            <label class="form-label">Upload CV (PDF)</label>
            <InputFile OnChange="OnInputFileChange" accept=".pdf" class="form-control border-dark" />
            @if (!string.IsNullOrEmpty(selectedFileName))
            {
                <p class="mt-1 text-success">‚úì Selected file: @selectedFileName</p>
            }
            @if (string.IsNullOrEmpty(selectedFileName) && !string.IsNullOrEmpty(statusMessage))
            {
                <p class="mt-1 text-danger">‚ö† No file selected</p>
            }
        </div>

        <button type="submit" class="btn btn-primary">Submit Application</button>
    </EditForm>


}

@code {
    [Parameter] public Guid JobId { get; set; }

    private JobDto job;
    private IBrowserFile selectedFile;
    private string selectedFileName;
    private string statusMessage;
    private ApplicationModel applicationModel = new();

    private string cvSavePath;
    private string userEmail = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var jobs = await Http.GetFromJsonAsync<List<JobDto>>("http://localhost:5142/api/Job");
            
            job = jobs.FirstOrDefault(j => j.Id == JobId);

            if (job == null)
                statusMessage = "Job not found.";
            
            if (await LocalStorage.ContainKeyAsync("isLoggedIn"))
            {
                userEmail = await LocalStorage.GetItemAsync<string>("userEmail");
                applicationModel.Email = userEmail;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error loading job: {ex.Message}";
        }
    }
    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = selectedFile?.Name;
        statusMessage = ""; 
    
        Console.WriteLine($"File selected: {selectedFileName}"); 
        StateHasChanged(); 
    }

private async Task HandleValidSubmit()
{
    statusMessage = "";
    Console.WriteLine("üöÄ Start HandleValidSubmit"); // punct 1

    if (selectedFile == null)
    {
        statusMessage = "‚ö† Please upload your CV (PDF file).";
        Console.WriteLine("‚ö† No file selected"); // punct 2
        StateHasChanged();
        return;
    }

    if (!selectedFile.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
    {
        statusMessage = "‚ö† Only PDF files are allowed.";
        Console.WriteLine("‚ö† Invalid file type"); // punct 3
        StateHasChanged();
        return;
    }

    try
    {
        statusMessage = "‚è≥ Uploading...";
        Console.WriteLine("‚è≥ Preparing MultipartFormDataContent"); // punct 4
        StateHasChanged();

        using var content = new MultipartFormDataContent();
        
        var stream = selectedFile.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024);
        var streamContent = new StreamContent(stream);
        streamContent.Headers.ContentType = 
            new System.Net.Http.Headers.MediaTypeHeaderValue("application/pdf");
        
        content.Add(streamContent, "cvFile", selectedFile.Name);
        content.Add(new StringContent(applicationModel.FullName ?? ""), "fullName");
        content.Add(new StringContent(applicationModel.Email ?? ""), "email");
        content.Add(new StringContent(JobId.ToString()), "jobId");
        content.Add(new StringContent(Guid.NewGuid().ToString()), "userId");

        Console.WriteLine("üì§ Sending POST request to API"); // punct 5
        var response = await Http.PostAsync("http://localhost:5142/api/Request/UploadCv", content);

        if (response.IsSuccessStatusCode)
        {
            statusMessage = "‚úÖ Application submitted successfully!";
            Console.WriteLine("‚úÖ Success!"); // punct 6
            // Reset form
            selectedFile = null;
            selectedFileName = null;
            applicationModel = new();
        }
        else
        {
            var errorContent = await response.Content.ReadAsStringAsync();
            statusMessage = $"‚ö† Error: {response.ReasonPhrase} - {errorContent}";
            Console.WriteLine($"‚ö† API Error: {response.ReasonPhrase} - {errorContent}"); // punct 7
        }
    }
    catch (Exception ex)
    {
        statusMessage = $"‚ùå Error: {ex.Message}";
        Console.WriteLine($"‚ùå Exception: {ex}"); // punct 8
    }
    finally
    {
        Console.WriteLine("üèÅ End HandleValidSubmit"); // punct 9
        StateHasChanged();
    }
}


    public class ApplicationModel
    {
        public string FullName { get; set; }
        public string Email { get; set; }
    }
}
