@page "/AddJob/{companyId:guid}"
@inject NavigationManager navManager
@inject HttpClient Http
@using Shared.DTOs

<div class="row justify-content-center">
    <div class="col-6">
        <EditForm method="post" FormName="AddJobForm" OnValidSubmit="AddJobForm" Model="JobFormModel" autocomplete="off">
            <DataAnnotationsValidator/>
            <h3>Add job form</h3>
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            
            <div class="mb-3">
                <label for="Title" class="form-label">Title</label>
                <InputText id="Title" @bind-Value="JobFormModel!.Title" class="form-control border-dark"/>
                <ValidationMessage For="@(() => JobFormModel!.Title)" />
            </div>
            
            <div class="mb-3">
                <label for="Description" class="form-label">Description</label>
                <InputTextArea id="Description" @bind-Value="JobFormModel!.Description" class="form-control border-dark" rows="4"/>
                <ValidationMessage For="@(() => JobFormModel!.Description)" />
            </div>
            
            <div class="mb-3">
                <label for="Skills" class="form-label">Skills</label>
                <InputText id="Skills" @bind-Value="JobFormModel!.Skills" class="form-control border-dark"/>
                <ValidationMessage For="@(() => JobFormModel!.Skills)" />
            </div>
            
            <div class="mb-3 form-check">
                <InputCheckbox id="IsSalaryMentionated" @bind-Value="JobFormModel!.IsSalaryMentionated" class="form-check-input border-dark"/>
                <label for="IsSalaryMentionated" class="form-check-label">Is salary mentioned</label>
            </div>
            
            @if (JobFormModel!.IsSalaryMentionated)
            {
                <div class="mb-3">
                    <label for="Salary" class="form-label">Salary</label>
                    <InputNumber id="Salary" @bind-Value="JobFormModel!.Salary" class="form-control border-dark"/>
                </div>
            }
            
            <div class="mb-3">
                <label for="Category" class="form-label">Category</label>
                <InputText id="Category" @bind-Value="JobFormModel!.Category" class="form-control border-dark"/>
                <ValidationMessage For="@(() => JobFormModel!.Category)" />
            </div>
            
            <div class="mb-3">
                <label for="Experience" class="form-label">Experience</label>
                <InputSelect id="Experience" @bind-Value="JobFormModel!.Experience" class="form-control border-dark">
                    <option value="0">No experience</option>
                    <option value="1">Small experience</option>
                    <option value="2">Medium experience</option>
                    <option value="3">Large experience</option>
                </InputSelect>
            </div>
            
            <div class="mb-3">
                <label for="WorkTime" class="form-label">Work time</label>
                <InputSelect id="WorkTime" @bind-Value="JobFormModel!.WorkTime" class="form-control border-dark">
                    <option value="0">Full time</option>
                    <option value="1">Part time</option>
                    <option value="2">Flexible time</option>
                    <option value="3">In turns</option>
                </InputSelect>
            </div>
            
            <div class="mb-3">
                <label for="Location" class="form-label">Location</label>
                <InputSelect id="Location" @bind-Value="JobFormModel!.Location" class="form-control border-dark">
                    <option value="0">Local</option>
                    <option value="1">Remote</option>
                    <option value="2">Hybrid</option>
                    <option value="3">In turns</option>
                </InputSelect>
            </div>
            
            <div class="mb-3">
                <button type="submit" class="btn btn-primary shadow-none">
                    Submit
                </button>
            </div>
            
            <ValidationSummary/>
        </EditForm>
    </div>
</div>

@code {
    [Parameter]
    public Guid companyId { get; set; }

    [SupplyParameterFromForm]
    private JobDto? JobFormModel { get; set; }

    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        // Initialize the form model with CompanyId
        JobFormModel ??= new JobDto 
        { 
            CompanyId = companyId 
        };
        
        Console.WriteLine($"Initialized with CompanyId: {companyId}");
    }

    private async Task AddJobForm()
    {
        try
        {
            errorMessage = string.Empty;
            
            // Ensure CompanyId is set (in case it was lost during form binding)
            if (JobFormModel != null)
            {
                JobFormModel.CompanyId = companyId;
                
                // Debug logging
                Console.WriteLine($"Submitting job with CompanyId: {JobFormModel.CompanyId}");
                Console.WriteLine($"Title: {JobFormModel.Title}");
                Console.WriteLine($"Description: {JobFormModel.Description}");
                Console.WriteLine($"Skills: {JobFormModel.Skills}");
                Console.WriteLine($"Category: {JobFormModel.Category}");
                
                var response = await Http.PostAsJsonAsync("http://localhost:5142/api/Job", JobFormModel);

                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine("Job added successfully!");
                    navManager.NavigateTo("/ShowJobs");
                }
                else
                {
                    var strResponse = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Error response: {strResponse}");
                    errorMessage = $"Failed to add job. Status: {response.StatusCode}";
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.Message}");
            errorMessage = $"An error occurred: {ex.Message}";
        }
    }
}